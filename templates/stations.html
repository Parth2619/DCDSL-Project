{% extends "base.html" %}

{% block title %}Monitoring Stations{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-broadcast-tower"></i> Monitoring Stations</h2>
        {% if role == 'admin' %}
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStationModal">
            <i class="fas fa-plus"></i> Add New Station
        </button>
        {% endif %}
    </div>
    
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="stationsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Station ID</th>
                            <th>Station Name</th>
                            <th>City</th>
                            <th>Type</th>
                            <th>Managed By</th>
                            {% if role == 'admin' %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for station in stations %}
                        <tr>
                            <td>{{ station.station_id }}</td>
                            <td><strong>{{ station.station_name }}</strong></td>
                            <td>{{ station.city_name }}, {{ station.state_name }}</td>
                            <td><span class="badge bg-info">{{ station.station_type }}</span></td>
                            <td>{{ station.managed_by }}</td>
                            {% if role == 'admin' %}
                            <td>
                                <button class="btn btn-sm btn-warning" 
                                        onclick="editStation({{ station | tojson | safe }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" 
                                        onclick="deleteStation({{ station.station_id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Station Modal -->
<div class="modal fade" id="addStationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Station</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_station') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Station ID <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="station_id" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City <span class="text-danger">*</span></label>
                            <select class="form-select" name="city_id" required>
                                <option value="">Select City</option>
                                {% for city in cities %}
                                <option value="{{ city.city_id }}">{{ city.city_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Station Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="station_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Station Type <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="station_type" 
                               value="Air Quality Monitoring Station" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Managed By <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="managed_by" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Station</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Station Modal -->
<div class="modal fade" id="editStationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Station</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editStationForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City <span class="text-danger">*</span></label>
                            <select class="form-select" name="city_id" id="edit_city_id" required>
                                {% for city in cities %}
                                <option value="{{ city.city_id }}">{{ city.city_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Station Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="station_name" id="edit_station_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Station Type <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="station_type" id="edit_station_type" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Managed By <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="managed_by" id="edit_managed_by" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update Station</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteStationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-trash"></i> Delete Station</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this station?</p>
                <p class="text-danger"><small>This action cannot be undone!</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteStationForm" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function editStation(station) {
        document.getElementById('edit_city_id').value = station.city_id;
        document.getElementById('edit_station_name').value = station.station_name;
        document.getElementById('edit_station_type').value = station.station_type;
        document.getElementById('edit_managed_by').value = station.managed_by;
        
        document.getElementById('editStationForm').action = '/stations/update/' + station.station_id;
        new bootstrap.Modal(document.getElementById('editStationModal')).show();
    }
    
    function deleteStation(stationId) {
        document.getElementById('deleteStationForm').action = '/stations/delete/' + stationId;
        new bootstrap.Modal(document.getElementById('deleteStationModal')).show();
    }
    
    $(document).ready(function() {
        $('#stationsTable').DataTable({
            "pageLength": 10,
            "order": [[2, "asc"]]
        });
    });
</script>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}
